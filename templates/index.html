{% extends "_base.html" %}
{% block body %}
<div class="container">
    <div class="header">
        <div class="header2">
            <h1>{{ identity.name }}</h1>
            {% include "_contact.html" %}
        </div>
    </div>
    <div id="main">
        {% include "_employment.html" %}
        {% include "_education.html" %}
        {% include "_projects.html" %}
        {% include "_skills.html" %}
    </div>
    <button id="print-button" class="btn" onclick="window.print()">Download</button>
    <div id="timestamps">
        <span>Accessed <span id="access_date"></span>.</span>
        <span id="updated_at"></span>
        <span id="html_url"></span>
    </div>
</div>
<script>
    var printDate = function (d) {
        // month is 0-indexed
        var month = d.getMonth() + 1;
        var day = d.getDate();
        var year = d.getFullYear();
        return month + "/" + day + "/" + year;
    }

    // Fetch data about a repository.
    var getRepo = function(repo_name, callback) {
        var respJson = sessionStorage.getItem(repo_name);
        if (respJson === null) {
            var url = (
            "https://api.github.com/repos/Ceasar/" + repo_name + "?callback=?");
            $.getJSON(url, function(resp) {
                sessionStorage.setItem(repo_name, JSON.stringify(resp));
                callback(resp);
            });
        } else {
            resp = JSON.parse(respJson);
            callback(resp);
        }
    }

    // Fill in information about a repository
    var updateProject = function(project, href, description, forksCount, stargazersCount) {
        $("#" + project + " .name a").attr("href", href);
        $("#" + project + " .description").text(description);
        $("#" + project + " .meta").text(
            "Forks: " + forksCount + ", Stars: " + stargazersCount
        );
    }

    $('#access_date').text(printDate(new Date()));
    $('#html_url').text(document.URL);

    getRepo("resume", function(resp) {
        if (resp.meta.status !== 403) {
            $("#updated_at").text(
                "Updated " + printDate(new Date(resp.data.updated_at))) + ".";
        }
    });

    var projects = [
    {% for project in projects %}
        "{{project}}"{% if not loop.last %},{% endif %}
    {%endfor %}
    ];
    $.each(projects, function(index, project) {
        getRepo(project, function(resp) {
            if (resp.meta.status !== 403) {
                updateProject(
                    project,
                    resp.data.html_url,
                    resp.data.description,
                    resp.data.forks_count,
                    resp.data.stargazers_count
                );
            }
        });
    });
</script>
{% endblock %}
